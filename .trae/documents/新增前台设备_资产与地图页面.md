## 目标
- 增加“前台”功能模块，包含五个独立路由页面：
  - 设备列表页：展示设备实体基础信息与所有属性。
  - 资产列表页：展示资产实体基础信息与所有属性。
  - 设备详情页：展示单设备的基础信息、属性与关联资产跳转入口。
  - 资产详情页：展示单资产的基础信息、属性与关联设备列表（可跳转设备详情）。
  - 地图页：展示设备与资产的地理坐标与状态。
- 前台模块在侧边菜单可见；列表页可跳转到相应详情页；详情页之间支持基于关联的互相跳转。

## 路由与菜单
- 新增路由模块 `src/router/routes/modules/portal.ts`，父级 `component: LAYOUT`，`path: '/portal'`，`meta.title: '前台'`，`icon: 'ant-design:deployment-unit-outlined'`，`authority: [TENANT_ADMIN, CUSTOMER_USER]`。
- 子路由：
  - `/portal/devices`：设备列表页。
  - `/portal/assets`：资产列表页。
  - `/portal/devices/:deviceId`：设备详情页（`hideMenu: true`）。
  - `/portal/assets/:assetId`：资产详情页（`hideMenu: true`）。
  - `/portal/map`：地图页。
- 菜单遵循现有风格配置 `tabIcon`、`orderNo`、`single`（参考 `src/router/routes/modules/tb.ts:104-140, 142-191`）。

## 页面架构与布局
- 独立页面与路由：
  - 设备列表：`src/views/portal/devices/index.vue`，路由 `/portal/devices`。
  - 资产列表：`src/views/portal/assets/index.vue`，路由 `/portal/assets`。
  - 设备详情：`src/views/portal/devices/detail.vue`，路由 `/portal/devices/:deviceId`。
  - 资产详情：`src/views/portal/assets/detail.vue`，路由 `/portal/assets/:assetId`。
- 响应式设计：
  - 使用栅格系统与断点 Hook 适配多屏（参考 `src/components/Form/src/hooks/useAdvanced.ts:1-12`）。
  - 列表页主内容区包含筛选区域与属性表格，窄屏折叠，宽屏分栏；详情页主内容区包含基础信息卡片、属性分组与关联区块。
- 页面布局：
  - 顶部导航栏与侧边菜单由 `LAYOUT` 提供，列表页与详情页均遵循一致的三段式布局。

## 数据接口规范
- 统一使用 ThingsBoard `entitiesQuery` 获取实体数据（参考 `src/api/tb/entityQuery.ts:14-21`）。
- 设备页请求参数：`entityFilter.type='entityType'`，`entityFilter.entityType=DEVICE`（参考 `src/enums/entityTypeEnum.ts:6-24`）。
- 资产页请求参数：`entityFilter.type='entityType'`，`entityFilter.entityType=ASSET`（参考 `src/enums/entityTypeEnum.ts:6-24`）。
- 接口响应需包含实体基础信息与所有属性：
  - `entityFields`：如 `name`、`type`、`label`、`createdTime`。
  - `latestValues`：按属性范围聚合，需覆盖客户端/服务端/共享属性（范围枚举参考 `src/enums/telemetryEnum.ts:1-20`）。
  - 如需动态获取属性键，使用 `findEntityKeyByQuery`（参考 `src/api/tb/entityQuery.ts:34-53`）。

## 属性展示配置
- 可配置的属性展示系统：通过配置文件指定展示字段与别名。
- 配置内容：
  - 字段集合：`fields: Array<{ key: string; alias?: string; group?: string; visible?: boolean }>`。
  - 排序：`order: Array<string>` 决定字段顺序，未列出字段按默认顺序附加。
  - 分组：`groups: Record<string, { title: string; order?: Array<string> }>` 控制分组与分组内排序。
  - 可见性：每个字段 `visible` 控制是否渲染。
- 推荐位置：`src/views/portal/config/attributes.ts`，按实体类型分别导出 `DEVICE_FIELDS` 与 `ASSET_FIELDS`。
- 渲染规则：
  - 表格列根据配置生成，`alias` 作为列标题显示名称。
  - `order` 决定列顺序，结合 Ant Design 表格排序。

## 功能实现细节
- 设备列表：展示所有设备实体与其配置属性；支持分页、模糊检索、属性筛选、排序；点击行或操作列跳转设备详情。
- 资产列表：展示所有资产实体与其配置属性；支持分页、模糊检索、属性筛选、排序；点击行或操作列跳转资产详情。
- 设备详情页：展示设备基础信息与属性；提供“跳转资产详情”按钮（若存在关联资产）。
- 资产详情页：展示资产基础信息与属性；展示关联设备列表，支持分页与搜索，并可点击跳转设备详情。
- 分页与搜索：通过 `pageLink.page/pageSize/textSearch` 实现。
- 排序：
  - 基础字段排序：`sortOrder: { direction: 'DESC'|'ASC', key: { type: 'ENTITY_FIELD', key } }`。
  - 属性列排序：表格侧本地排序；如需服务端排序，需将属性作为 `latestValues` 并映射排序字段。

## 接口调用示例代码

```ts
import { findEntityDataByQuery, findEntityKeyByQuery } from '/@/api/tb/entityQuery';
import { EntityType } from '/@/enums/entityTypeEnum';

async function fetchDevices(page = 0, pageSize = 20, textSearch?: string) {
  const query = {
    entityFilter: { type: 'entityType', entityType: EntityType.DEVICE },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: {
      page,
      pageSize,
      textSearch: textSearch || null,
      sortOrder: { direction: 'DESC', key: { type: 'ENTITY_FIELD', key: 'createdTime' } },
    },
    latestValues: [
      { type: 'ATTRIBUTE', key: 'active' },
      { type: 'ATTRIBUTE', key: 'lastActivityTime' },
    ],
  };
  return await findEntityDataByQuery(query);
}

async function fetchAssets(page = 0, pageSize = 20, textSearch?: string) {
  const query = {
    entityFilter: { type: 'entityType', entityType: EntityType.ASSET },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: {
      page,
      pageSize,
      textSearch: textSearch || null,
      sortOrder: { direction: 'DESC', key: { type: 'ENTITY_FIELD', key: 'createdTime' } },
    },
    latestValues: [
      { type: 'ATTRIBUTE', key: 'active' },
      { type: 'ATTRIBUTE', key: 'lastActivityTime' },
    ],
  };
  return await findEntityDataByQuery(query);
}

// 详情页：按ID获取基础信息（设备/资产）
import { getDeviceInfoById } from '/@/api/tb/device';
import { getAssetInfoById } from '/@/api/tb/asset';

async function fetchDeviceDetail(deviceId: string) {
  return await getDeviceInfoById(deviceId); // 参考 `src/api/tb/device.ts:26-33`
}

async function fetchAssetDetail(assetId: string) {
  return await getAssetInfoById(assetId); // 参考 `src/api/tb/asset.ts:34-41`
}

async function fetchAllAttributeKeysForDevices() {
  const data = { entityFilter: { type: 'entityType', entityType: EntityType.DEVICE } };
  const keysServer = await findEntityKeyByQuery({ attributes: true, timeseries: false, scope: 'SERVER_SCOPE' }, data);
  const keysClient = await findEntityKeyByQuery({ attributes: true, timeseries: false, scope: 'CLIENT_SCOPE' }, data);
  const keysShared = await findEntityKeyByQuery({ attributes: true, timeseries: false, scope: 'SHARED_SCOPE' }, data);
  return { server: keysServer, client: keysClient, shared: keysShared };
}
```

示例中的查询方法来源：`src/api/tb/entityQuery.ts:14-21, 44-53`；实体类型枚举：`src/enums/entityTypeEnum.ts:6-24`。

## 属性配置格式说明

```ts
// src/views/portal/config/attributes.ts
export const DEVICE_FIELDS = {
  fields: [
    { key: 'name', alias: '名称', group: 'basic', visible: true },
    { key: 'type', alias: '类型', group: 'basic', visible: true },
    { key: 'label', alias: '标签', group: 'basic', visible: true },
    { key: 'active', alias: '在线', group: 'status', visible: true },
    { key: 'lastActivityTime', alias: '最后活动时间', group: 'status', visible: true },
  ],
  order: ['name', 'type', 'label', 'active', 'lastActivityTime'],
  groups: {
    basic: { title: '基础信息', order: ['name', 'type', 'label'] },
    status: { title: '状态信息', order: ['active', 'lastActivityTime'] },
  },
};

export const ASSET_FIELDS = {
  fields: [
    { key: 'name', alias: '名称', group: 'basic', visible: true },
    { key: 'type', alias: '类型', group: 'basic', visible: true },
    { key: 'label', alias: '标签', group: 'basic', visible: true },
  ],
  order: ['name', 'type', 'label'],
  groups: { basic: { title: '基础信息', order: ['name', 'type', 'label'] } },
};
```

## 页面效果示意图
- 设备页列表与属性分组示意：`![Devices Page](../../public/docs/portal-devices.png)`
- 资产页列表与属性分组示意：`![Assets Page](../../public/docs/portal-assets.png)`

## 测试用例与验证步骤
- 测试范围：分页、搜索、排序、属性渲染与配置生效。
- 组件测试建议：使用 `@vue/test-utils` 对设备页与资产页进行渲染与交互测试。
- 典型用例：
  - 渲染设备页并断言配置字段与别名正确显示。
  - 输入关键字触发 `textSearch`，断言查询参数与表格数据更新。
  - 切换分页与排序，断言 `pageLink` 与排序参数更新。
  - 修改配置中 `visible=false` 的字段不显示。
- 手工验证步骤：
  - 安装依赖并启动开发：`pnpm install && pnpm dev`（脚本参考 `package.json:6-23`）。
  - 访问设备页 `/portal/devices` 与资产页 `/portal/assets`。
  - 检查响应式布局在不同分辨率下的效果（宽屏分栏、窄屏折叠）。
  - 验证分页、搜索、排序，以及属性别名与分组渲染是否正确。

## 页面：地图
- 目录：`src/views/portal/map/index.vue`。
- 地图库：复用已集成的百度地图 WebGL（`BMapGL`）。
- 加载方式：使用 `useBMap(import.meta.env.VITE_BAIDU_MAP_AK)`（参考 `src/hooks/web/useBMap.ts:3-41`），避免硬编码 AK。
- 数据来源：
  - WebSocket 优先：`WsCmdType.ENTITY_DATA` 订阅最新值（经纬度、在线状态、活动时间、名称等），失败回退 HTTP（参考 `src/views/tb/desktop/components/chart/GeoMap.vue:73-121, 152-168`）。
  - 支持设备与资产切换（两类 `entityFilter`）。
- 展示：
  - Marker + InfoWindow：名称、标签、在线状态、最后活动时间。
  - 资源较多时可加聚合（后续增强）。
- 快捷跳转：按钮“前往设备列表”“前往资产列表”链接至现有页面（参考 `src/router/routes/modules/tb.ts:155-166, 167-177`）。

## 数据接口
- 统一改为使用 `entitiesQuery` 检索实体数据：
  - 统计：`countEntitiesByQuery(query)`（`src/api/tb/entityQuery.ts:10-13`）。
  - 数据：`findEntityDataByQuery(query)`（`src/api/tb/entityQuery.ts:14-21`）。
  - 键名：`findEntityKeyByQuery(params, data)`（`src/api/tb/entityQuery.ts:34-53`）。
- 遥测/属性补充接口仍可用于单实体查看与图表：
  - 最新遥测：`getLatestTimeseries(entityId, keys?)`（`src/api/tb/telemetry.ts:82-88`）。
  - 历史遥测：`getTimeseries(params)`（`src/api/tb/telemetry.ts:90-95`）。
  - 属性：`getAttributesByScope(entityId, scope)`（`src/api/tb/telemetry.ts:75-80`）。

## 图表与地图实现
- 图表：
  - 统一用 `useECharts` 初始化与自适应，序列为所选时序键的 `TsKvEntity[key].data`（参考 `src/views/tb/telemetry/timeseriesChart.vue`）。
- 地图：
  - 抽取 `GeoMap` 逻辑复用，修正 `longitude` 取值（`GeoMap.vue:161-165, 174`）并参数化实体类型与键名。

## 权限与导航
- `meta.authority: [TENANT_ADMIN, CUSTOMER_USER]`，与现有实体页一致（参考 `tb.ts:146-165, 168-177`）。
- 在前台页提供返回原有导航的入口：
  - 列表页操作列跳转 `/device/list`、`/asset/list`（或直接跳转至前台详情页）。
  - 地图页顶部按钮跳转上述列表路由。

### 设备与资产的关联互跳
- 目标：基于实体关系，在设备页与资产页互相跳转并按关联结果过滤列表。
- 跳转协议：使用查询参数传递关系上下文，例如：
  - 从设备页跳转资产页：`/portal/assets?rootType=DEVICE&rootId=<deviceId>&direction=TO&relationType=Contains`。
  - 从资产页跳转设备页：`/portal/devices?rootType=ASSET&rootId=<assetId>&direction=TO&relationType=Contains`。
- 加载策略：
  - 若收到上述查询参数，页面改用 `relationsQuery` 作为 `entityFilter`，按关系筛选目标实体；否则使用默认 `entityType` 过滤。
  - 关系查询结构参考：`src/api/model/baseModel.ts:101-114`，过滤项枚举参考：`src/enums/entityTypeEnum.ts:6-24`、`src/enums/relationEnum.ts:1-13`、`src/enums/queryEnum.ts:1-15`。

示例（资产页按设备关联加载资产）：
```ts
import { findEntityDataByQuery } from '/@/api/tb/entityQuery';
import { EntityType } from '/@/enums/entityTypeEnum';

async function fetchAssetsRelatedToDevice(deviceId: string, relationType = 'Contains') {
  const query = {
    entityFilter: {
      type: 'relationsQuery',
      parameters: {
        rootId: deviceId,
        rootType: EntityType.DEVICE,
        direction: 'TO',
        relationTypeGroup: 'COMMON',
        maxLevel: 1,
        fetchLastLevelOnly: true,
      },
      filters: [{ relationType, entityTypes: [EntityType.ASSET], negate: false }],
    },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: { page: 0, pageSize: 20, textSearch: null },
  };
  return await findEntityDataByQuery(query);
}
```

示例（设备页按资产关联加载设备）：
```ts
import { findEntityDataByQuery } from '/@/api/tb/entityQuery';
import { EntityType } from '/@/enums/entityTypeEnum';

async function fetchDevicesRelatedToAsset(assetId: string, relationType = 'Contains') {
  const query = {
    entityFilter: {
      type: 'relationsQuery',
      parameters: {
        rootId: assetId,
        rootType: EntityType.ASSET,
        direction: 'TO',
        relationTypeGroup: 'COMMON',
        maxLevel: 1,
        fetchLastLevelOnly: true,
      },
      filters: [{ relationType, entityTypes: [EntityType.DEVICE], negate: false }],
    },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: { page: 0, pageSize: 20, textSearch: null },
  };
  return await findEntityDataByQuery(query);
}
```

备用方案：若需先解析具体关系，可用关系接口获取实体 ID，再以 `entityList` 过滤加载：
```ts
import { findRelationListByFrom, findRelationListByTo } from '/@/api/tb/relation';
// 根据实际方向选择 from/to
// 得到目标实体 ID 列表后：
const entityFilter = { type: 'entityList', entityType: EntityType.ASSET, entityList: assetIds };
```

## 文案与样式
- 菜单与页标题使用 i18n：在 `src/locales/lang/zh-CN/routes/portal.ts` 与英文包添加键，如 `routes.portal.front`, `routes.portal.entities`, `routes.portal.map`。
- 表格列标题、按钮文案复用现有风格与组件（`ant-design-vue`）。

## 验证与交付
- 路由出现在侧栏菜单，点击进入两页面。
- 设备页与资产页分别加载列表，支持搜索、分页与排序；图表 Drawer 能显示选中键的历史曲线。
- 地图加载成功（需要配置 `VITE_BAIDU_MAP_AK`），设备/资产 Marker 正确显示坐标、状态与信息窗口；跳转按钮正常导航到原有列表。

## 变更清单
- 新增：
  - `src/router/routes/modules/portal.ts`（前台模块路由）。
  - `src/views/portal/devices/index.vue`（设备列表页）。
  - `src/views/portal/assets/index.vue`（资产列表页）。
  - `src/views/portal/devices/detail.vue`（设备详情页）。
  - `src/views/portal/assets/detail.vue`（资产详情页）。
  - `src/views/portal/map/index.vue`（地图页）。
  - `src/locales/lang/zh-CN/routes/portal.ts`、`src/locales/lang/en/routes/portal.ts`（文案）。
- 更新（如需）：
  - `src/views/tb/desktop/components/chart/GeoMap.vue`（抽取/复用与小修正）。
  - `.env*` 增加 `VITE_BAIDU_MAP_AK`。

## 后续可选增强
- Marker 聚合与热力图。
- 图表页支持实时订阅与阈值告警提示。
- 自定义列配置与导出。
- 支持资产与设备的关联过滤（按监测站展示资产-设备树）。

## 模糊检索与属性筛选
- 模糊检索（设备页与资产页均支持）：
  - 通过 `pageLink.textSearch` 向 `findEntityDataByQuery` 传递搜索关键字，后端按名称等基础字段进行模糊匹配（参考 `src/api/model/baseModel.ts:21-28`）。
  - UI：在筛选区提供搜索输入框，实时或按回车触发查询，并结合防抖处理（参考 `src/components/Application/src/search/useMenuSearch.ts:1-16` 与 `@vueuse/core` 防抖）。
- 属性筛选（设备页与资产页均支持）：
  - 使用 `keyFilters: Array<KeyFilter>` 构建筛选条件，字段由 `EntityKey` 指定，支持属性与时序键（参考 `src/api/model/entityQuery/keyFilter.ts:1-58`，`src/enums/queryEnum.ts:1-53`）。
  - 支持多类型谓词：
    - 布尔：`EQUAL`（如 `active==true`），示例参考 `src/views/tb/desktop/components/DeviceCountCard.vue:100-124`。
    - 字符串：`CONTAINS`/`STARTS_WITH`/`ENDS_WITH` 等，支持 `ignoreCase`。
    - 数值：`GREATER`/`LESS`/`EQUAL` 等，示例参考 `src/views/tb/desktop/components/chart/GeoMap.vue:91-113`（`latitude>0`）。
  - 键类型：`ATTRIBUTE`/`CLIENT_ATTRIBUTE`/`SERVER_ATTRIBUTE`/`SHARED_ATTRIBUTE`/`TIME_SERIES`（参考 `src/enums/queryEnum.ts:20-37`）。

### 示例：模糊检索 + 属性筛选
```ts
import { findEntityDataByQuery } from '/@/api/tb/entityQuery';
import { EntityType } from '/@/enums/entityTypeEnum';

async function fetchDevicesWithSearchAndFilters(keyword?: string) {
  const query = {
    entityFilter: { type: 'entityType', entityType: EntityType.DEVICE },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: {
      page: 0,
      pageSize: 20,
      textSearch: keyword || null,
      sortOrder: { direction: 'DESC', key: { type: 'ENTITY_FIELD', key: 'createdTime' } },
    },
    keyFilters: [
      {
        valueType: 'BOOLEAN',
        key: { type: 'ATTRIBUTE', key: 'active' },
        predicate: { type: 'BOOLEAN', operation: 'EQUAL', value: { defaultValue: true } },
      },
      {
        valueType: 'STRING',
        key: { type: 'ATTRIBUTE', key: 'label' },
        predicate: { type: 'STRING', operation: 'CONTAINS', value: { defaultValue: keyword || '' }, ignoreCase: true },
      },
    ],
    latestValues: [
      { type: 'ATTRIBUTE', key: 'active' },
      { type: 'ATTRIBUTE', key: 'lastActivityTime' },
    ],
  };
  return await findEntityDataByQuery(query);
}

async function fetchAssetsWithSearchAndFilters(keyword?: string) {
  const query = {
    entityFilter: { type: 'entityType', entityType: EntityType.ASSET },
    entityFields: [
      { type: 'ENTITY_FIELD', key: 'name' },
      { type: 'ENTITY_FIELD', key: 'type' },
      { type: 'ENTITY_FIELD', key: 'label' },
      { type: 'ENTITY_FIELD', key: 'createdTime' },
    ],
    pageLink: {
      page: 0,
      pageSize: 20,
      textSearch: keyword || null,
      sortOrder: { direction: 'DESC', key: { type: 'ENTITY_FIELD', key: 'createdTime' } },
    },
    keyFilters: [
      {
        valueType: 'STRING',
        key: { type: 'ATTRIBUTE', key: 'label' },
        predicate: { type: 'STRING', operation: 'CONTAINS', value: { defaultValue: keyword || '' }, ignoreCase: true },
      },
    ],
  };
  return await findEntityDataByQuery(query);
}
```

### 测试要点更新
- 模糊检索：输入关键字更新 `pageLink.textSearch`，断言查询返回数据符合预期。
- 属性筛选：选择布尔/字符串/数值筛选项后，断言生成的 `keyFilters` 结构与服务端返回数据符合预期。
